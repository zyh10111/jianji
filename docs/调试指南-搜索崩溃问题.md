# 调试指南：搜索崩溃问题

本文档说明如何调试和查看搜索功能的错误信息。

---

## 🔍 如何查看错误日志

### 方法一：使用 Expo Go（开发环境）

1. **打开终端/命令行**
   - 运行 `npm start` 或 `expo start`
   - 查看终端输出

2. **查看控制台日志**
   - 在终端中会显示所有 `console.log`、`console.error` 输出
   - 错误信息会以红色显示

3. **使用 Chrome DevTools（推荐）**
   ```bash
   # 启动 Expo
   npm start
   
   # 按 'j' 键打开调试器
   # 或访问 http://localhost:19002/debugger-ui
   ```

### 方法二：使用 React Native Debugger

1. **安装 React Native Debugger**
   - 下载：https://github.com/jhen0409/react-native-debugger/releases

2. **启动调试器**
   - 运行应用
   - 在设备上摇一摇，选择 "Debug"
   - 或按 `Cmd+D` (Mac) / `Ctrl+M` (Android)

3. **查看错误**
   - 在调试器的 Console 标签页查看错误
   - 在 Sources 标签页查看源代码和断点

### 方法三：使用 ADB Logcat（Android）

```bash
# 连接 Android 设备或模拟器
adb logcat | grep -i "error\|exception\|crash"
```

### 方法四：使用 Xcode Console（iOS）

1. 打开 Xcode
2. 运行应用
3. 在 Xcode 底部查看 Console 输出

---

## 🐛 常见崩溃原因

### 1. 日期格式化错误

**错误信息**：
```
Invalid Date
TypeError: Cannot read property 'toLocaleDateString' of undefined
```

**原因**：`item.updatedAt` 为无效日期或 undefined

**已修复**：添加了日期安全检查

### 2. 正则表达式错误

**错误信息**：
```
SyntaxError: Invalid regular expression
```

**原因**：搜索关键词包含特殊字符（如 `[`, `(`, `*` 等）

**已修复**：转义特殊字符

### 3. 空值访问错误

**错误信息**：
```
TypeError: Cannot read property 'title' of undefined
TypeError: Cannot read property 'length' of null
```

**原因**：笔记数据不完整，某些字段为 null/undefined

**已修复**：添加了所有字段的安全检查

### 4. 数组操作错误

**错误信息**：
```
TypeError: item.tags.some is not a function
TypeError: Cannot read property 'length' of undefined
```

**原因**：`tags` 不是数组或为 null

**已修复**：添加了数组类型检查

---

## 🔧 已实施的修复

### 1. 搜索函数安全检查

```javascript
// 所有字段都进行了安全检查
const titleMatch = note.title && note.title.toLowerCase().includes(lowerQuery);
const contentMatch = note.content && note.content.toLowerCase().includes(lowerQuery);
const tagsMatch = note.tags && Array.isArray(note.tags) && 
  note.tags.some(tag => tag && tag.toLowerCase().includes(lowerQuery));
```

### 2. 渲染函数安全检查

```javascript
// 安全获取字段值
const safeTitle = item.title || '无标题';
const safeContent = item.content || '';
const safeCategory = item.category || '其他';
const safeTags = Array.isArray(item.tags) ? item.tags : [];
```

### 3. 日期格式化安全检查

```javascript
// 安全地格式化日期
if (item.updatedAt) {
  const date = new Date(item.updatedAt);
  if (!isNaN(date.getTime())) {
    formattedDate = date.toLocaleDateString(...);
  }
}
```

### 4. 正则表达式转义

```javascript
// 转义特殊字符
const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
```

### 5. 错误边界组件

添加了 `ErrorBoundary` 组件来捕获未处理的错误。

---

## 📝 调试步骤

### 步骤 1：查看控制台日志

运行应用后，查看终端或调试器的控制台输出：

```bash
npm start
# 查看终端输出
```

### 步骤 2：重现问题

1. 打开搜索页面
2. 输入搜索关键词
3. 观察控制台是否有错误信息

### 步骤 3：检查错误信息

查找以下关键词：
- `Error:`
- `TypeError:`
- `搜索失败:`
- `渲染搜索结果项失败:`
- `搜索单个笔记时出错:`

### 步骤 4：查看错误详情

错误信息会包含：
- 错误类型
- 错误消息
- 出错的笔记数据
- 堆栈跟踪

---

## 🛠️ 手动测试

### 测试 1：正常搜索

```javascript
// 应该正常工作
搜索关键词："测试"
```

### 测试 2：特殊字符搜索

```javascript
// 应该不会崩溃
搜索关键词："[测试]"
搜索关键词："(测试)"
搜索关键词："*测试*"
```

### 测试 3：空数据搜索

```javascript
// 即使笔记数据不完整，也不应该崩溃
// 创建一些缺少字段的笔记，然后搜索
```

### 测试 4：边界情况

```javascript
// 空搜索
搜索关键词：""

// 很长的搜索词
搜索关键词："这是一个非常长的搜索关键词..."

// 特殊字符
搜索关键词："!@#$%^&*()"
```

---

## 📋 错误报告模板

如果问题仍然存在，请提供以下信息：

1. **错误信息**：
   ```
   从控制台复制的完整错误信息
   ```

2. **重现步骤**：
   ```
   1. 打开应用
   2. 点击搜索
   3. 输入关键词："..."
   4. 应用崩溃
   ```

3. **环境信息**：
   - 设备：Android/iOS
   - 系统版本：...
   - Expo SDK 版本：50.0.0
   - React Native 版本：0.73.6

4. **笔记数据**：
   ```
   如果有问题的笔记数据，请提供
   ```

---

## 🔍 检查清单

如果搜索仍然崩溃，检查以下内容：

- [ ] 控制台是否有错误日志？
- [ ] 错误信息是什么？
- [ ] 是在输入时崩溃，还是在显示结果时崩溃？
- [ ] 是否有特定的搜索关键词会导致崩溃？
- [ ] 笔记数据是否完整？
- [ ] 是否有旧的不完整数据？

---

## 💡 临时解决方案

如果问题持续存在，可以：

1. **清除应用数据**
   ```bash
   # Android
   adb shell pm clear com.noteease.app
   
   # 或重新安装应用
   ```

2. **检查笔记数据**
   - 删除可能有问题的笔记
   - 重新创建笔记

3. **查看完整错误日志**
   - 使用 React Native Debugger
   - 或查看完整的 logcat 输出

---

## 📞 获取帮助

如果问题仍然存在：

1. **查看完整错误日志**
   - 使用上述方法查看控制台
   - 复制完整的错误信息

2. **检查代码**
   - 查看 `src/screens/SearchScreen.js`
   - 查看 `src/services/noteService.js`

3. **提供错误信息**
   - 包含完整的错误堆栈
   - 包含出错的笔记数据（如果有）

---

**文档版本**：v1.0  
**最后更新**：2024年
